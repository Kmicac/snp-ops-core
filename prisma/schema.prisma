generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum WorkOrderStatus {
  SCHEDULED
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELED
  DELAYED
}

enum ServiceCategory {
  CLEANING
  SECURITY
  TRANSPORT
  LOGISTICS
  EQUIPMENT
  CATERING
  OTHER
}

enum OrgRole {
  SUPER_ADMIN
  HR
  EVENT_DIRECTOR
  HEAD_REFEREE
  TECH_SYSTEMS
  GUADA
}

enum StaffRole {
  STAFF
  SECURITY
  LOGISTICS
  CLEANING
  REFEREE
  MEDIC
  PRODUCTION
  TICKETING
  OTHER
}

enum CredentialStatus {
  ACTIVE
  REVOKED
}

enum AuditEntityType {
  ORGANIZATION
  EVENT
  PROVIDER
  PROVIDER_SERVICE
  WORK_ORDER
  WORK_ORDER_EVIDENCE
  STAFF_MEMBER
  STAFF_ASSIGNMENT
  SHIFT
  CREDENTIAL
  SCAN_LOG
  USER
  INCIDENT
  IMPROVEMENT
}

enum AuditActionType {
  CREATED
  UPDATED
  DELETED
  STATUS_CHANGED
  LOGIN
  LOGOUT
  OTHER
  EVIDENCE_ADDED
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  CLOSED
}

enum ImprovementType {
  IMPROVEMENT
  INNOVATION
  PROCESS
}

enum ImprovementStatus {
  PROPOSED
  APPROVED
  IN_PROGRESS
  IMPLEMENTED
  REJECTED
}

// CORE MODELS

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events       Event[]
  providers    Provider[]
  memberships  OrgMembership[]
  staffMembers StaffMember[]
  auditLogs    AuditLog[]
  improvements Improvement[]
}

model Venue {
  id        String   @id @default(cuid())
  name      String
  address   String?
  city      String?
  country   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events Event[]
}

model Event {
  id             String    @id @default(cuid())
  organizationId String
  code           String    @unique
  name           String
  startDate      DateTime?
  endDate        DateTime?
  venueId        String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id])
  venue            Venue?            @relation(fields: [venueId], references: [id])
  zones            Zone[]
  providerServices ProviderService[]
  workOrders       WorkOrder[]

  shifts       Shift[]
  assignments  StaffAssignment[]
  credentials  Credential[]
  scanLogs     ScanLog[]
  auditLogs    AuditLog[]
  incidents    Incident[]
  improvements Improvement[]

  @@index([organizationId])
}

model Zone {
  id        String   @id @default(cuid())
  eventId   String
  name      String
  type      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event       Event             @relation(fields: [eventId], references: [id])
  workOrders  WorkOrder[]
  assignments StaffAssignment[]
  scanLogs    ScanLog[]
  incidents   Incident[]

  @@index([eventId])
}

// PROVIDERS

model Provider {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  email          String?
  phone          String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id])
  services     ProviderService[]

  @@index([organizationId])
}

model ProviderService {
  id                 String          @id @default(cuid())
  providerId         String
  eventId            String
  category           ServiceCategory
  name               String
  slaMinutes         Int?
  windowSlackMinutes Int?
  notes              String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  provider   Provider    @relation(fields: [providerId], references: [id])
  event      Event       @relation(fields: [eventId], references: [id])
  workOrders WorkOrder[]

  @@unique([providerId, eventId, name])
  @@index([eventId])
  @@index([providerId])
}

// WORK ORDERS

model WorkOrder {
  id                String          @id @default(cuid())
  eventId           String
  zoneId            String?
  providerServiceId String
  title             String
  description       String?
  scheduledStartAt  DateTime?
  scheduledEndAt    DateTime?
  status            WorkOrderStatus @default(SCHEDULED)

  acceptedAt  DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  delayedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event           Event               @relation(fields: [eventId], references: [id])
  zone            Zone?               @relation(fields: [zoneId], references: [id])
  providerService ProviderService     @relation(fields: [providerServiceId], references: [id])
  evidences       WorkOrderEvidence[]

  @@index([eventId, status])
  @@index([providerServiceId])
  @@index([zoneId])
}

model WorkOrderEvidence {
  id          String   @id @default(cuid())
  workOrderId String
  type        String
  url         String?
  note        String?
  createdAt   DateTime @default(now())

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id])

  @@index([workOrderId])
}

// AUTH / RBAC

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  fullName     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  memberships OrgMembership[]
  scanLogs    ScanLog[]       @relation("ScanLogScannerUser")
  auditLogs   AuditLog[]

  incidents    Incident[]
  improvements Improvement[]
}

model OrgMembership {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@unique([organizationId, userId, role])
  @@index([organizationId])
  @@index([userId])
}

// STAFF / SHIFTS / CREDENTIALS / SCANS

model StaffMember {
  id             String   @id @default(cuid())
  organizationId String
  fullName       String
  documentId     String?
  phone          String?
  email          String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id])
  assignments  StaffAssignment[]
  credentials  Credential[]

  @@index([organizationId])
}

model Shift {
  id        String   @id @default(cuid())
  eventId   String
  name      String
  startsAt  DateTime
  endsAt    DateTime
  createdAt DateTime @default(now())

  event       Event             @relation(fields: [eventId], references: [id])
  assignments StaffAssignment[]

  @@index([eventId])
}

model StaffAssignment {
  id            String    @id @default(cuid())
  eventId       String
  staffMemberId String
  role          StaffRole
  zoneId        String?
  shiftId       String?
  startsAt      DateTime?
  endsAt        DateTime?
  createdAt     DateTime  @default(now())

  event       Event       @relation(fields: [eventId], references: [id])
  staffMember StaffMember @relation(fields: [staffMemberId], references: [id])
  zone        Zone?       @relation(fields: [zoneId], references: [id])
  shift       Shift?      @relation(fields: [shiftId], references: [id])

  @@index([eventId])
  @@index([staffMemberId])
  @@index([zoneId])
  @@index([shiftId])
}

model Credential {
  id            String           @id @default(cuid())
  eventId       String
  staffMemberId String
  status        CredentialStatus @default(ACTIVE)
  qrToken       String           @unique
  issuedAt      DateTime         @default(now())
  revokedAt     DateTime?

  event       Event       @relation(fields: [eventId], references: [id])
  staffMember StaffMember @relation(fields: [staffMemberId], references: [id])
  scans       ScanLog[]

  @@index([eventId])
  @@index([staffMemberId])
}

model ScanLog {
  id            String   @id @default(cuid())
  credentialId  String? // nullable para loguear tokens inv√°lidos
  eventId       String
  zoneId        String?
  scannerUserId String?
  scannedAt     DateTime @default(now())
  result        String
  reason        String?

  credential Credential? @relation(fields: [credentialId], references: [id])
  event      Event       @relation(fields: [eventId], references: [id])
  zone       Zone?       @relation(fields: [zoneId], references: [id])

  scannerUser User? @relation("ScanLogScannerUser", fields: [scannerUserId], references: [id])

  @@index([eventId, scannedAt])
  @@index([credentialId])
  @@index([scannerUserId])
  @@index([zoneId])
}

model AuditLog {
  id             String          @id @default(cuid())
  organizationId String?
  eventId        String?
  userId         String?
  entityType     AuditEntityType
  entityId       String
  action         AuditActionType
  message        String?
  changes        Json?
  ip             String?
  userAgent      String?
  createdAt      DateTime        @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id])
  event        Event?        @relation(fields: [eventId], references: [id])
  user         User?         @relation(fields: [userId], references: [id])

  @@index([organizationId, createdAt])
  @@index([eventId, createdAt])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
}

model Incident {
  id           String           @id @default(cuid())
  eventId      String
  zoneId       String?
  reportedById String?
  title        String
  description  String
  severity     IncidentSeverity
  status       IncidentStatus   @default(OPEN)
  occurredAt   DateTime?
  resolvedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event      Event @relation(fields: [eventId], references: [id])
  zone       Zone? @relation(fields: [zoneId], references: [id])
  reportedBy User? @relation(fields: [reportedById], references: [id])

  improvements Improvement[]
  evidences    IncidentEvidence[]

  @@index([eventId])
  @@index([status])
  @@index([severity])
}

model IncidentEvidence {
  id         String   @id @default(cuid())
  incidentId String
  type       String
  url        String?
  note       String?
  createdAt  DateTime @default(now())

  incident Incident @relation(fields: [incidentId], references: [id])

  @@index([incidentId])
}

model Improvement {
  id             String  @id @default(cuid())
  organizationId String
  eventId        String?
  incidentId     String?
  createdById    String?

  title       String
  description String
  type        ImprovementType
  status      ImprovementStatus @default(PROPOSED)
  priority    Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  event        Event?       @relation(fields: [eventId], references: [id])
  incident     Incident?    @relation(fields: [incidentId], references: [id])
  createdBy    User?        @relation(fields: [createdById], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([type])
}
